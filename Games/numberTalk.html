<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Number AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #6C5CE7;
            --success: #00B894;
            --error: #FF7675;
            --bg: #F0F3F7;
        }

        body {
            margin: 0;
            background: var(--bg);
            font-family: 'Quicksand', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #2D3436;
        }

        #game-container {
            background: white;
            padding: 2.5rem;
            border-radius: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.05);
            text-align: center;
            width: 350px;
            position: relative;
        }

        .level-badge {
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: inline-block;
        }

        #number-display {
            font-family: 'Fredoka One', cursive;
            font-size: 9rem;
            margin: 10px 0;
            color: var(--primary);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .mic-btn {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 3rem;
            cursor: pointer;
            box-shadow: 0 10px 0 #5444c4;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
        }

        .mic-btn:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #5444c4;
        }

        .mic-btn.listening {
            animation: pulse 1.2s infinite;
            background: #FD79A8;
            box-shadow: 0 10px 0 #e84393;
        }

        #feedback-area {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .progress-bar {
            position: absolute;
            bottom: -30px;
            left: 0;
            width: 100%;
            height: 12px;
            background: #dfe6e9;
            border-radius: 10px;
            overflow: hidden;
        }

        #progress-fill {
            height: 100%;
            background: var(--success);
            width: 1%;
            transition: width 0.5s ease;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0px rgba(253, 121, 168, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(253, 121, 168, 0); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="level-badge">Step <span id="lvl-txt">1</span> of 100</div>
        <div id="number-display">1</div>
        
        <button id="mic-btn" class="mic-btn" title="Click to speak">ðŸŽ¤</button>
        
        <div id="feedback-area">
            <span id="msg">Tap the mic to start!</span>
        </div>

        <div class="progress-bar">
            <div id="progress-fill"></div>
        </div>
    </div>

    <script>
        const state = {
            target: parseInt(localStorage.getItem('kidGameLevel')) || 1,
            busy: false
        };

        const el = {
            num: document.getElementById('number-display'),
            msg: document.getElementById('msg'),
            btn: document.getElementById('mic-btn'),
            fill: document.getElementById('progress-fill'),
            lvl: document.getElementById('lvl-txt')
        };

        // Initialize Web Speech
        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const speech = new Recognition();
        speech.lang = 'en-US';

        // 1. Audio Engine (Beeps & Boops)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            if (type === 'success') {
                osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                osc.frequency.exponentialRampToValueAtTime(1046.50, audioCtx.currentTime + 0.3); // C6
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
                osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        // 2. Main Game Logic
        function updateDisplay() {
            el.num.innerText = state.target;
            el.lvl.innerText = state.target;
            el.fill.style.width = `${state.target}%`;
            el.num.style.transform = "scale(1.2)";
            setTimeout(() => el.num.style.transform = "scale(1)", 200);
        }

        el.btn.onclick = () => {
            if (state.busy) return;
            speech.start();
        };

        speech.onstart = () => {
            state.busy = true;
            el.btn.classList.add('listening');
            el.msg.innerText = "Listening...";
        };

        speech.onresult = async (event) => {
            const transcript = event.results[0][0].transcript;
            el.btn.classList.remove('listening');
            el.msg.innerText = "Checking...";
            
            const isCorrect = await validateWithAI(transcript, state.target);
            
            if (isCorrect) {
                handleSuccess();
            } else {
                handleFailure();
            }
        };

        speech.onend = () => {
            el.btn.classList.remove('listening');
            state.busy = false;
        };

        // 3. AI Semantic Validation
        async function validateWithAI(spoken, expected) {
            const systemContext = "You are a teacher checking if a child said the correct number. They might have an accent or say extra words.";
            const userPrompt = `The expected number is ${expected}. The child said: '${spoken}'. Is the child correct? Reply only with YES or NO.`;
            
            const fullPrompt = `${systemContext}\n\n${userPrompt}`;
            const url = `https://text.pollinations.ai/${encodeURIComponent(fullPrompt)}`;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout
                
                const response = await fetch(url, { signal: controller.signal });
                const text = await response.text();
                return text.trim().toUpperCase().includes('YES');
            } catch (err) {
                console.warn("AI Offline, using fallback", err);
                return spoken.includes(expected.toString());
            }
        }

        function handleSuccess() {
            playSound('success');
            confetti({ particleCount: 50, spread: 60, colors: ['#6C5CE7', '#00B894'] });
            
            el.msg.style.color = 'var(--success)';
            el.msg.innerText = "Great Job! â­";
            
            setTimeout(() => {
                state.target++;
                localStorage.setItem('kidGameLevel', state.target);
                el.msg.style.color = '';
                el.msg.innerText = "Next one!";
                updateDisplay();
            }, 1500);
        }

        function handleFailure() {
            playSound('fail');
            el.msg.style.color = 'var(--error)';
            el.msg.innerText = "Nice try! Let's try again! â¤ï¸";
            setTimeout(() => {
                el.msg.style.color = '';
                el.msg.innerText = "Tap the mic to try again!";
            }, 2000);
        }

        updateDisplay();
    </script>
</body>
</html>