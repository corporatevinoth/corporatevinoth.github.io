<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speak & Count ‚Äì Random AI Challenge</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #6C5CE7;
            --success: #00B894;
            --error: #FF7675;
            --bg: #F0F3F7;
        }

        body {
            margin: 0; background: var(--bg); font-family: 'Quicksand', sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden; touch-action: manipulation;
        }

        #top-bar {
            position: absolute; top: 20px; width: 85%; display: flex; 
            justify-content: space-between; align-items: center;
            font-family: 'Fredoka One', cursive; color: var(--primary); font-size: 1.5rem;
        }

        #game-card {
            background: white; padding: 2rem; border-radius: 50px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.1); text-align: center;
            width: 85%; max-width: 400px;
        }

        #number-display {
            font-family: 'Fredoka One', cursive; font-size: 10rem;
            margin: 10px 0; color: var(--primary); line-height: 1;
        }

        .mic-btn {
            width: 130px; height: 130px; border-radius: 50%; border: none;
            background: var(--primary); color: white; font-size: 4rem;
            cursor: pointer; box-shadow: 0 10px 0 #5444c4; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center;
        }

        .mic-btn.listening {
            animation: pulse 1s infinite;
            background: #FD79A8;
            box-shadow: 0 10px 0 #e84393;
        }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-15px); } 75% { transform: translateX(15px); } }

        #msg { font-weight: bold; font-size: 1.3rem; min-height: 3em; color: #2d3436; padding: 0 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="top-bar">
        <div>‚≠ê Stars: <span id="star-count">0</span></div>
        <div style="font-size: 0.8rem">Numbers Left: <span id="left-count">100</span></div>
    </div>

    <main id="game-card">
        <div id="number-display">?</div>
        <button id="mic-btn" class="mic-btn">üé§</button>
        <div id="msg">Tap the mic and say the number!</div>
    </main>

    <script>
        const state = {
            target: 0,
            stars: parseInt(localStorage.getItem('sc_stars_v2')) || 0,
            completed: JSON.parse(localStorage.getItem('sc_completed')) || [],
            isListening: false
        };

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const synth = window.speechSynthesis;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;

        function pickNewNumber() {
            if (state.completed.length >= 100) {
                state.completed = []; // Reset if all 100 done
            }
            
            let next;
            do {
                next = Math.floor(Math.random() * 100) + 1;
            } while (state.completed.includes(next));
            
            state.target = next;
            updateUI("Say the number you see!");
        }

        async function validateWithAI(spokenText) {
            // Strict Prompting to fix the "always successful" bug
            const prompt = `You are a strict validator. The target number is ${state.target}. The user said: "${spokenText}". If they said the correct number, reply YES. If they said any other number or word, reply NO. Do not be helpful, just reply YES or NO.`;
            
            try {
                const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
                const result = await response.text();
                const normalized = result.trim().toUpperCase();
                
                // Double check: AI must say YES AND the transcript shouldn't be empty
                return normalized.includes("YES") && spokenText.length > 0;
            } catch (error) {
                // Manual fallback check
                const words = spokenText.split(' ');
                return words.includes(state.target.toString());
            }
        }

        function handleSuccess() {
            state.stars++;
            state.completed.push(state.target);
            localStorage.setItem('sc_stars_v2', state.stars);
            localStorage.setItem('sc_completed', JSON.stringify(state.completed));
            
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            updateUI("üåü Correct! üåü", true);
            
            const utter = new SpeechSynthesisUtterance("Correct!");
            utter.pitch = 1.5;
            synth.speak(utter);

            setTimeout(pickNewNumber, 2000);
        }

        function handleFailure(heard) {
            document.getElementById('game-card').classList.add('shake');
            setTimeout(() => document.getElementById('game-card').classList.remove('shake'), 400);
            
            updateUI(`I heard "${heard}". Try again!`, false);
            const utter = new SpeechSynthesisUtterance("Not quite, try again!");
            utter.pitch = 1.2;
            synth.speak(utter);
        }

        function updateUI(msg, isSuccess = null) {
            document.getElementById('number-display').innerText = state.target;
            document.getElementById('star-count').innerText = state.stars;
            document.getElementById('left-count').innerText = 100 - state.completed.length;
            const msgEl = document.getElementById('msg');
            msgEl.innerText = msg;
            msgEl.style.color = isSuccess === true ? "#00B894" : (isSuccess === false ? "#FF7675" : "#2d3436");
        }

        const micBtn = document.getElementById('mic-btn');
        micBtn.onclick = () => {
            if (recognition && !state.isListening) recognition.start();
        };

        if (recognition) {
            recognition.onstart = () => {
                state.isListening = true;
                micBtn.classList.add('listening');
                updateUI("Listening...");
            };
            recognition.onend = () => {
                state.isListening = false;
                micBtn.classList.remove('listening');
            };
            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                const isCorrect = await validateWithAI(transcript);
                isCorrect ? handleSuccess() : handleFailure(transcript);
            };
        }

        pickNewNumber();
    </script>
</body>
</html>