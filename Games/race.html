<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Race Game</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { background: #222; display: block; margin: 0 auto; }
    #controls { display: none; position: fixed; bottom: 40px; left: 0; width: 100%; text-align: center; }
    #controls button { font-size: 2em; margin: 0 20px; }
    #game-over-modal {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #fff; padding: 30px 40px; border-radius: 20px; box-shadow: 0 6px 40px #0009; text-align: center; z-index: 1000;
    }
    #game-over-modal button { font-size: 1.5em; margin: 10px 20px; }
    #score-label { font-size: 2em; margin-bottom: 20px; color: #222; font-weight: bold; }
    @media (pointer: coarse) {
      #controls { display: block; }
    }
  </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<button id="speakerBtn" title="Toggle music" style="position:fixed;right:12px;top:12px;z-index:999;background:transparent;border:none;font-size:1.6rem;cursor:pointer;">üîà</button>
<div id="controls">
  <button id="leftBtn">‚¨ÖÔ∏è</button>
  <button id="rightBtn">‚û°Ô∏è</button>
</div>
<div id="game-over-modal">
  <div id="score-label"></div>
  <button onclick="replayGame()">Replay</button>
  <button onclick="exitGame()">Exit</button>
</div>
<script>
const carImages = [
  '../resources/bluecar.jpg', '../resources/greencar.png', '../resources/jeep.png', '../resources/purplecar.png', '../resources/truck.png'
];
const playerCarImage = '../resources/redcar.jpg';
const carWidth = 60, carHeight = 100;
let cars = [];
let coins = [];
let player = { x: 0, y: 0, img: null, vx: 0 };
let canvas = document.getElementById('gameCanvas');
let ctx = canvas.getContext('2d');
let gameRunning = false;
let score = 0;
let scoreInterval = null;

// For road animation
let roadLineOffset = 0;
const roadLineSpeed = 10;

// Responsive sizing
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  player.x = canvas.width/2 - carWidth/2;
  player.y = canvas.height - carHeight - 30;
}
window.addEventListener('resize', resize);

// Load images
function loadImage(src) {
  const img = new Image();
  img.src = src;
  return img;
}
let loadedImages = { player: loadImage(playerCarImage) };
carImages.forEach((src, i) => loadedImages[i] = loadImage(src));

// Draw road with animated dotted center line
function drawRoad() {
  ctx.fillStyle = 'black';
  ctx.fillRect(canvas.width/4, 0, canvas.width/2, canvas.height);
  ctx.strokeStyle = 'white';
  ctx.lineWidth = 6;
  ctx.setLineDash([30, 30]);
  ctx.beginPath();
  ctx.moveTo(canvas.width/2, -roadLineOffset % 60);
  ctx.lineTo(canvas.width/2, canvas.height);
  ctx.stroke();
  ctx.setLineDash([]);
}

// Draw cars
function drawCoins() {
  // coins rotate vertically: simulate by scaling y of coin ellipse based on angle
  coins.forEach(c => {
    c.angle += c.spin;
    const scale = Math.abs(Math.cos(c.angle)); // 0..1
    const cx = c.x + c.size/2;
    const cy = c.y + c.size/2;
    ctx.save();
    ctx.translate(cx, cy);
    ctx.scale(1, 0.5 + 0.5*scale);
    // coin body
    ctx.fillStyle = '#ffd700';
    ctx.beginPath();
    ctx.arc(0, 0, c.size/2, 0, Math.PI*2);
    ctx.fill();
    // coin inner shine
    ctx.fillStyle = 'rgba(255,255,255,0.35)';
    ctx.beginPath();
    ctx.ellipse(-c.size*0.12, -c.size*0.12, c.size*0.18, c.size*0.08, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  });
}

function drawCars() {
  cars.forEach(car => {
    ctx.drawImage(loadedImages[car.imgIdx], car.x, car.y, carWidth, carHeight);
  });
}

function drawPlayer() {
  // draw shadow
  ctx.save();
  ctx.fillStyle = 'rgba(0,0,0,0.35)';
  ctx.beginPath();
  ctx.ellipse(player.x + carWidth/2, player.y + carHeight - 6, carWidth*0.6, 10, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.restore();

  // tilt based on velocity
  const tilt = Math.max(-0.25, Math.min(0.25, player.vx / 12));
  ctx.save();
  ctx.translate(player.x + carWidth/2, player.y + carHeight/2);
  ctx.rotate(tilt);
  ctx.drawImage(loadedImages.player, -carWidth/2, -carHeight/2, carWidth, carHeight);
  ctx.restore();
}

// Collision detection
function isColliding(a, b) {
  return !(
    a.x + carWidth < b.x ||
    a.x > b.x + carWidth ||
    a.y + carHeight < b.y ||
    a.y > b.y + carHeight
  );
}

function isCollidingCoin(a, coin) {
  // simple AABB vs coin box
  return !(a.x + carWidth < coin.x || a.x > coin.x + coin.size || a.y + carHeight < coin.y || a.y > coin.y + coin.size);
}

// Prevent cars from spawning/colliding in the same lane/row
function isCarOverlap(newCar, allCars) {
  return allCars.some(car =>
    Math.abs(car.x - newCar.x) < carWidth && Math.abs(car.y - newCar.y) < carHeight
  );
}

// Game loop
function gameLoop() {
  if (!gameRunning) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  roadLineOffset += roadLineSpeed;
  drawRoad();
  // Move cars
  cars.forEach(car => {
    car.y += car.speed;
    if (car.y > canvas.height) {
      // Reposition car at top, random lane, ensure no overlap with other cars
      let tries = 0;
      do {
        car.x = canvas.width/4 + Math.floor(Math.random() * 3)*(canvas.width/2- carWidth)/2;
        car.y = -carHeight - Math.random()*150;
        tries++;
      } while (isCarOverlap(car, cars.filter(c => c !== car)) && tries < 10);
    }
  });

  // Move coins
  coins.forEach((c, idx) => {
    c.y += c.speed;
    if (c.y > canvas.height) {
      // recycle
      c.y = -c.size - Math.random()*200;
      c.x = canvas.width/4 + Math.floor(Math.random()*3) * ((canvas.width/2 - carWidth)/2) + 10;
    }
    // check collection
    if (isCollidingCoin(player, c)) {
      score += 10;
      // remove coin and respawn
      c.y = -c.size - Math.random()*300;
      c.x = canvas.width/4 + Math.floor(Math.random()*3) * ((canvas.width/2 - carWidth)/2) + 10;
    }
  });

  drawCoins();
  drawCars();
  drawPlayer();

  // Check collision (only player with other cars)
  for (let i = 0; i < cars.length; ++i) {
    if (isColliding(player, cars[i])) {
      endGame();
      return;
    }
  }

  requestAnimationFrame(gameLoop);
}

// Controls (continuous)
const moveSpeed = 8;
function stopPlayer() { player.vx = 0; }
function startMoveLeft() { player.vx = -moveSpeed; }
function startMoveRight() { player.vx = moveSpeed; }

window.addEventListener('keydown', e => {
  if (!gameRunning) return;
  if (e.key === 'ArrowLeft' || e.key === 'Left' || e.keyCode === 37) startMoveLeft();
  if (e.key === 'ArrowRight' || e.key === 'Right' || e.keyCode === 39) startMoveRight();
});
window.addEventListener('keyup', e => {
  if (e.key === 'ArrowLeft' || e.keyCode === 37) stopPlayer();
  if (e.key === 'ArrowRight' || e.keyCode === 39) stopPlayer();
});

// Touch buttons: press & hold
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
leftBtn.addEventListener('pointerdown', () => { if (gameRunning) startMoveLeft(); });
leftBtn.addEventListener('pointerup', () => { if (gameRunning) stopPlayer(); });
rightBtn.addEventListener('pointerdown', () => { if (gameRunning) startMoveRight(); });
rightBtn.addEventListener('pointerup', () => { if (gameRunning) stopPlayer(); });

// Handle score
function startScore() {
  score = 0;
  document.getElementById('score-label').innerText = '';
  if (scoreInterval) clearInterval(scoreInterval);
  scoreInterval = setInterval(() => {
    if (gameRunning) score++;
  }, 100);
}
function stopScore() {
  if (scoreInterval) clearInterval(scoreInterval);
  document.getElementById('score-label').innerText = "Your Score: " + score;
}

// Game over UI
function endGame() {
  gameRunning = false;
  stopScore();
  document.getElementById('game-over-modal').style.display = 'block';
}
function replayGame() {
  document.getElementById('game-over-modal').style.display = 'none';
  init();
}
function exitGame() {
  window.location.href = 'https://corporatevinoth.github.io/';
}

// Initialize
function init() {
  resize();
  cars = [];
  coins = [];
  let lanes = [0, 1, 2];
  for (let i = 0; i < 5; ++i) {
    // Assign random lane and y position, ensure no overlap at spawn
    let car, tries = 0;
    do {
      const lane = Math.floor(Math.random() * 3);
      const x = canvas.width/4 + lane*(canvas.width/2- carWidth)/2;
      const y = 100 + i*150 + Math.random()*80;
      car = {
        x: x,
        y: y,
        imgIdx: i,
        speed: 5 + Math.random()*3
      };
      tries++;
    } while (isCarOverlap(car, cars) && tries < 10);
    cars.push(car);
  }
  // spawn some coins
  for (let i = 0; i < 6; ++i) {
    const lane = Math.floor(Math.random()*3);
    const x = canvas.width/4 + lane*(canvas.width/2- carWidth)/2 + 10;
    const y = 50 + i*180 + Math.random()*120;
    coins.push({ x: x, y: y, size: 28, speed: 3 + Math.random()*2, angle: Math.random()*Math.PI*2, spin: 0.15 + Math.random()*0.2 });
  }
  player.x = canvas.width/2 - carWidth/2;
  player.y = canvas.height - carHeight - 30;
  player.img = loadedImages.player;
  gameRunning = true;
  startScore();
  gameLoop();
}
// Simple background music using WebAudio (starts on user gesture)
let audioCtx = null;
let musicGain = null;
let musicOsc1 = null;
let musicOsc2 = null;
let musicPlaying = false;

function startMusic() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    musicGain = audioCtx.createGain();
    musicGain.gain.value = 0.06; // low volume
    musicGain.connect(audioCtx.destination);

    musicOsc1 = audioCtx.createOscillator();
    musicOsc1.type = 'sine';
    musicOsc1.frequency.value = 110;
    musicOsc1.connect(musicGain);

    musicOsc2 = audioCtx.createOscillator();
    musicOsc2.type = 'sawtooth';
    musicOsc2.frequency.value = 220;
    const g2 = audioCtx.createGain(); g2.gain.value = 0.02; g2.connect(musicGain);
    musicOsc2.connect(g2);

    musicOsc1.start();
    musicOsc2.start();
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
  musicPlaying = true;
  document.getElementById('speakerBtn').textContent = 'üîä';
}

function stopMusic() {
  if (musicGain) musicGain.gain.value = 0;
  musicPlaying = false;
  document.getElementById('speakerBtn').textContent = 'üîà';
}

document.getElementById('speakerBtn').addEventListener('click', () => {
  if (!musicPlaying) startMusic(); else stopMusic();
});

window.onload = init;
</script>
</body>
</html>
