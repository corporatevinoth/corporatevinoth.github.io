<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Bottle Blast 3D - Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            overflow: hidden;
            background: #000;
            height: 100vh;
            width: 100vw;
            touch-action: none;
        }

        #gameContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Start Screen */
        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            z-index: 1000;
            overflow-y: auto;
        }

        .game-title {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            color: #fff;
        }

        .game-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .instructions {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            max-width: 400px;
        }

        .instruction-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .instruction-icon {
            font-size: 1.5em;
            margin-right: 15px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
        }

        .mobile-controls-demo {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .control-demo {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
        }

        #startButton {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(255,107,107,0.3);
            transition: transform 0.2s;
            width: 80%;
            max-width: 300px;
        }

        #startButton:active {
            transform: scale(0.95);
        }

        /* Mobile Control Overlays */
        #touchControls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            z-index: 100;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            padding: 20px;
            opacity: 0.9;
        }

        /* Left Joystick Area */
        #leftJoystickArea {
            width: 150px;
            height: 150px;
            position: relative;
            pointer-events: auto;
        }

        #joystickBase {
            width: 120px;
            height: 120px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            left: 0;
            backdrop-filter: blur(10px);
        }

        #joystickHandle {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }

        /* Right Touch Area for Look/Aim */
        #rightTouchArea {
            width: 60%;
            height: 100%;
            pointer-events: auto;
            position: relative;
        }

        /* Action Buttons */
        #actionButtons {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 101;
            pointer-events: none;
        }

        .action-btn {
            width: 70px;
            height: 70px;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: white;
            cursor: pointer;
            pointer-events: auto;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .action-btn:active {
            transform: scale(0.9);
            background: rgba(255,255,255,0.3);
        }

        #shootBtn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff4757 100%);
            border-color: rgba(255,255,255,0.5);
        }

        #reloadBtn {
            background: linear-gradient(135deg, #2ed573 0%, #1e90ff 100%);
            border-color: rgba(255,255,255,0.5);
        }

        #slowMotionBtn {
            background: linear-gradient(135deg, #3742fa 0%, #5352ed 100%);
            border-color: rgba(255,255,255,0.5);
        }

        /* Game HUD */
        #gameHUD {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            z-index: 99;
            pointer-events: none;
        }

        .hud-item {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 1em;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        #scoreDisplay {
            font-size: 1.2em;
            font-weight: bold;
        }

        #ammoDisplay {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ammo-bar {
            width: 100px;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .ammo-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd32a 0%, #ffa801 100%);
            border-radius: 4px;
            transition: width 0.3s;
        }

        #slowMotionBar {
            width: 100px;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .slowMotion-fill {
            height: 100%;
            background: linear-gradient(90deg, #18dcff 0%, #7d5fff 100%);
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* Crosshair */
        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            pointer-events: none;
            z-index: 98;
        }

        .crosshair-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: rgba(0, 255, 0, 0.9);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .crosshair-line {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
        }

        .crosshair-line.horizontal {
            width: 20px;
            height: 2px;
            top: 50%;
            transform: translateY(-50%);
        }

        .crosshair-line.horizontal.left {
            right: 50%;
            margin-right: 10px;
        }

        .crosshair-line.horizontal.right {
            left: 50%;
            margin-left: 10px;
        }

        .crosshair-line.vertical {
            width: 2px;
            height: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .crosshair-line.vertical.top {
            bottom: 50%;
            margin-bottom: 10px;
        }

        .crosshair-line.vertical.bottom {
            top: 50%;
            margin-top: 10px;
        }

        /* Hit Marker */
        .hit-marker {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 50, 50, 0.8);
            pointer-events: none;
            z-index: 97;
            animation: hitPulse 0.3s ease-out;
        }

        @keyframes hitPulse {
            0% { opacity: 1; transform: translate(-50%, -50%) rotate(45deg) scale(0.5); }
            100% { opacity: 0; transform: translate(-50%, -50%) rotate(45deg) scale(1.5); }
        }

        /* Power-up Indicator */
        .power-up-indicator {
            position: fixed;
            bottom: 150px;
            right: 30px;
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 99;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .power-up-icon {
            font-size: 1.5em;
        }

        /* Game Over Screen */
        #gameOverScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            z-index: 2000;
        }

        .game-over-title {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        .stats-container {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            min-width: 300px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #restartButton {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            margin-top: 30px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        /* Mobile-specific adjustments */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2em;
            }
            
            .instruction-item {
                font-size: 0.9em;
            }
            
            .action-btn {
                width: 60px;
                height: 60px;
                font-size: 1.5em;
            }
            
            .hud-item {
                padding: 10px 15px;
                font-size: 0.9em;
            }
            
            #joystickBase {
                width: 100px;
                height: 100px;
            }
            
            #joystickHandle {
                width: 50px;
                height: 50px;
            }
        }

        /* Landscape mode optimization */
        @media (orientation: landscape) {
            #touchControls {
                height: 50%;
            }
            
            .action-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }
            
            .hud-item {
                padding: 8px 12px;
                font-size: 0.8em;
            }
        }

        /* Vibration effect */
        @keyframes vibrate {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-2px, 2px); }
            50% { transform: translate(2px, -2px); }
            75% { transform: translate(-2px, -2px); }
            100% { transform: translate(0, 0); }
        }

        .vibrate {
            animation: vibrate 0.1s linear 2;
        }

        /* Screen shake for hit */
        @keyframes screenShake {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-5px, 5px); }
            50% { transform: translate(5px, -5px); }
            75% { transform: translate(-5px, -5px); }
            100% { transform: translate(0, 0); }
        }

        .screen-shake {
            animation: screenShake 0.2s linear;
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="startScreen">
        <div class="game-icon">üè∫üéØ</div>
        <h1 class="game-title">BOTTLE BLAST 3D</h1>
        <p style="margin-bottom: 20px; color: rgba(255,255,255,0.8);">Shoot bottles in slow motion! Mobile optimized.</p>
        
        <div class="instructions">
            <div class="instruction-item">
                <div class="instruction-icon">üëÜ</div>
                <div>Touch & drag right side to look around</div>
            </div>
            <div class="instruction-item">
                <div class="instruction-icon">üïπÔ∏è</div>
                <div>Left joystick to move</div>
            </div>
            <div class="instruction-item">
                <div class="instruction-icon">üî¥</div>
                <div>Red button to shoot</div>
            </div>
            <div class="instruction-item">
                <div class="instruction-icon">üåÄ</div>
                <div>Blue button for slow motion</div>
            </div>
            <div class="instruction-item">
                <div class="instruction-icon">üì±</div>
                <div>Tilt phone to aim (optional)</div>
            </div>
        </div>

        <div style="margin: 20px 0; color: rgba(255,255,255,0.6); font-size: 0.9em;">
            Turn on sound for best experience!
        </div>

        <button id="startButton">START SHOOTING</button>
        
        <div style="margin-top: 30px; font-size: 0.8em; color: rgba(255,255,255,0.5);">
            Works best in landscape mode
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer"></div>

    <!-- Crosshair -->
    <div id="crosshair">
        <div class="crosshair-dot"></div>
        <div class="crosshair-line horizontal left"></div>
        <div class="crosshair-line horizontal right"></div>
        <div class="crosshair-line vertical top"></div>
        <div class="crosshair-line vertical bottom"></div>
    </div>

    <!-- Game HUD -->
    <div id="gameHUD">
        <div class="hud-item" id="scoreDisplay">
            SCORE: <span id="score">0</span>
        </div>
        <div class="hud-item">
            TIME: <span id="timeDisplay">90</span>s
        </div>
        <div class="hud-item">
            <div id="ammoDisplay">
                <span id="ammoCount">12</span>/12
                <div class="ammo-bar">
                    <div class="ammo-fill" id="ammoFill"></div>
                </div>
            </div>
            <div id="slowMotionBar">
                <div class="slowMotion-fill" id="slowMotionFill"></div>
            </div>
        </div>
    </div>

    <!-- Mobile Controls -->
    <div id="touchControls">
        <!-- Left Joystick -->
        <div id="leftJoystickArea">
            <div id="joystickBase"></div>
            <div id="joystickHandle"></div>
        </div>

        <!-- Right Touch Area (for looking around) -->
        <div id="rightTouchArea"></div>
    </div>

    <!-- Action Buttons -->
    <div id="actionButtons">
        <button class="action-btn" id="slowMotionBtn">üåÄ</button>
        <button class="action-btn" id="reloadBtn">üîÉ</button>
        <button class="action-btn" id="shootBtn">üî¥</button>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen">
        <div class="game-icon">üèÜ</div>
        <h1 class="game-over-title">MISSION COMPLETE</h1>
        
        <div class="stats-container">
            <div class="stat-item">
                <span>FINAL SCORE:</span>
                <span id="finalScore">0</span>
            </div>
            <div class="stat-item">
                <span>BOTTLES SHOT:</span>
                <span id="finalBottles">0</span>
            </div>
            <div class="stat-item">
                <span>ACCURACY:</span>
                <span id="finalAccuracy">0%</span>
            </div>
            <div class="stat-item">
                <span>BEST COMBO:</span>
                <span id="finalCombo">0</span>
            </div>
            <div class="stat-item">
                <span>TIME LEFT:</span>
                <span id="finalTime">0s</span>
            </div>
        </div>

        <button id="restartButton">PLAY AGAIN</button>
    </div>

    <!-- Audio Elements -->
    <audio id="shootSound" preload="auto"></audio>
    <audio id="reloadSound" preload="auto"></audio>
    <audio id="bottleBreakSound" preload="auto"></audio>
    <audio id="glassSound" preload="auto"></audio>
    <audio id="slowMotionSound" preload="auto"></audio>
    <audio id="powerUpSound" preload="auto"></audio>
    <audio id="explosionSound" preload="auto"></audio>
    <audio id="buttonSound" preload="auto"></audio>
    <audio id="hitSound" preload="auto"></audio>
    <audio id="backgroundMusic" loop preload="auto"></audio>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/DeviceOrientationControls.js"></script>
    
    <script>
        // Game Variables
        let scene, camera, renderer, controls;
        let bottles = [];
        let particles = [];
        let clock = new THREE.Clock();
        let gameActive = false;
        
        // Game State
        let score = 0;
        let bottlesShot = 0;
        let totalBottles = 15;
        let ammo = 12;
        let maxAmmo = 12;
        let gameTime = 90; // 90 seconds
        let combo = 0;
        let comboTimeout = null;
        let multiplier = 1;
        let shotsFired = 0;
        let shotsHit = 0;
        let slowMotionCharge = 100;
        let maxSlowMotion = 100;
        let slowMotionActive = false;
        let slowMotionTime = 5; // 5 seconds
        let gameTimer = null;
        
        // Particles list - FIXED: Added missing variable declaration
        let particlesList = [];
        
        // Mobile Controls
        let joystickActive = false;
        let joystickPosition = { x: 0, y: 0 };
        let lookTouchActive = false;
        let lastTouchX = 0;
        let lastTouchY = 0;
        let lookSensitivity = 0.002;
        let moveSpeed = 5;
        let playerVelocity = new THREE.Vector3();
        let canJump = false;
        
        // Gyroscope
        let gyroEnabled = false;
        let deviceOrientationControls = null;
        
        // Initialize Game
        async function init() {
            // Create scene
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x87CEEB, 10, 100);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 0);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit pixel ratio for mobile performance
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            document.getElementById('gameContainer').appendChild(renderer.domElement);
            
            // Setup lighting
            setupLighting();
            
            // Create environment
            createEnvironment();
            
            // Create bottles
            createBottles(totalBottles);
            
            // Setup controls
            setupControls();
            
            // Setup audio
            setupAudio();
            
            // Update HUD
            updateHUD();
            
            // Start game loop
            animate();
            
            // Show orientation warning for portrait mode
            if (window.innerHeight > window.innerWidth) {
                showOrientationWarning();
            }
        }
        
        function setupLighting() {
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            // Directional light (sun)
            const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
            sunLight.position.set(50, 100, 50);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 1024;
            sunLight.shadow.mapSize.height = 1024;
            sunLight.shadow.camera.near = 0.5;
            sunLight.shadow.camera.far = 200;
            scene.add(sunLight);
            
            // Hemisphere light
            const hemisphereLight = new THREE.HemisphereLight(0x87CEEB, 0x3a7d34, 0.3);
            scene.add(hemisphereLight);
        }
        
        function createEnvironment() {
            // Ground
            const groundGeometry = new THREE.PlaneGeometry(100, 100);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x3a7d34 
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Sky
            const skyGeometry = new THREE.SphereGeometry(200, 32, 32);
            const skyMaterial = new THREE.MeshBasicMaterial({
                color: 0x87CEEB,
                side: THREE.BackSide
            });
            const sky = new THREE.Mesh(skyGeometry, skyMaterial);
            scene.add(sky);
            
            // Create shooting range backdrop
            createBackdrop();
            
            // Add some trees for visual reference
            createTrees();
        }
        
        function createBackdrop() {
            // Back wall
            const wallGeometry = new THREE.BoxGeometry(60, 20, 2);
            const wallMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            const wall = new THREE.Mesh(wallGeometry, wallMaterial);
            wall.position.set(0, 10, -30);
            wall.receiveShadow = true;
            scene.add(wall);
            
            // Target stands
            for (let i = 0; i < 5; i++) {
                const standGeometry = new THREE.BoxGeometry(2, 4, 2);
                const standMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
                const stand = new THREE.Mesh(standGeometry, standMaterial);
                stand.position.set(-20 + i * 10, 2, -25);
                stand.castShadow = true;
                scene.add(stand);
            }
        }
        
        function createTrees() {
            const treePositions = [
                [-35, 0, -15], [35, 0, -15],
                [-40, 0, 20], [40, 0, 20],
                [0, 0, 35]
            ];
            
            treePositions.forEach(pos => {
                // Trunk
                const trunkGeometry = new THREE.CylinderGeometry(0.5, 0.7, 5);
                const trunkMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
                const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
                trunk.position.set(pos[0], 2.5, pos[2]);
                trunk.castShadow = true;
                scene.add(trunk);
                
                // Leaves
                const leavesGeometry = new THREE.ConeGeometry(3, 6, 8);
                const leavesMaterial = new THREE.MeshLambertMaterial({ color: 0x2E8B57 });
                const leaves = new THREE.Mesh(leavesGeometry, leavesMaterial);
                leaves.position.set(pos[0], 7, pos[2]);
                leaves.castShadow = true;
                scene.add(leaves);
            });
        }
        
        function createBottles(count) {
            for (let i = 0; i < count; i++) {
                createBottle();
            }
        }
        
        function createBottle() {
            const colors = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00, 0xff00ff];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            // Bottle geometry (simplified for mobile)
            const group = new THREE.Group();
            
            // Main bottle body
            const bottleGeometry = new THREE.CylinderGeometry(0.3, 0.5, 1.5, 16);
            const bottleMaterial = new THREE.MeshPhongMaterial({
                color: color,
                transparent: true,
                opacity: 0.8,
                shininess: 100
            });
            const bottle = new THREE.Mesh(bottleGeometry, bottleMaterial);
            bottle.castShadow = true;
            group.add(bottle);
            
            // Bottle neck
            const neckGeometry = new THREE.CylinderGeometry(0.15, 0.2, 0.5, 8);
            const neck = new THREE.Mesh(neckGeometry, bottleMaterial);
            neck.position.y = 1.1;
            neck.castShadow = true;
            group.add(neck);
            
            // Position bottle randomly in the air
            group.position.set(
                (Math.random() - 0.5) * 40,
                Math.random() * 10 + 5,
                -20 + Math.random() * 10
            );
            
            // Physics properties
            group.userData = {
                velocity: new THREE.Vector3(
                    (Math.random() - 0.5) * 0.5,
                    Math.random() * 0.2,
                    (Math.random() - 0.5) * 0.5
                ),
                angularVelocity: new THREE.Vector3(
                    (Math.random() - 0.5) * 2,
                    (Math.random() - 0.5) * 2,
                    (Math.random() - 0.5) * 2
                ),
                gravity: 0.01,
                active: true,
                color: color
            };
            
            bottles.push(group);
            scene.add(group);
            
            return group;
        }
        
        function setupControls() {
            // Touch controls
            setupTouchControls();
            
            // Button events
            setupButtonEvents();
            
            // Gyroscope setup (optional)
            setupGyroscope();
            
            // Window resize
            window.addEventListener('resize', onWindowResize);
            
            // Orientation change
            window.addEventListener('orientationchange', onOrientationChange);
        }
        
        function setupTouchControls() {
            const joystickArea = document.getElementById('leftJoystickArea');
            const joystickHandle = document.getElementById('joystickHandle');
            const joystickBase = document.getElementById('joystickBase');
            const rightTouchArea = document.getElementById('rightTouchArea');
            
            // Joystick touch start
            joystickArea.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
                updateJoystickPosition(e.touches[0]);
            });
            
            // Joystick touch move
            joystickArea.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (joystickActive) {
                    updateJoystickPosition(e.touches[0]);
                }
            });
            
            // Joystick touch end
            joystickArea.addEventListener('touchend', (e) => {
                e.preventDefault();
                joystickActive = false;
                joystickPosition = { x: 0, y: 0 };
                joystickHandle.style.transform = 'translate(-50%, -50%)';
            });
            
            // Look touch start
            rightTouchArea.addEventListener('touchstart', (e) => {
                e.preventDefault();
                lookTouchActive = true;
                lastTouchX = e.touches[0].clientX;
                lastTouchY = e.touches[0].clientY;
            });
            
            // Look touch move
            rightTouchArea.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (lookTouchActive && gameActive) {
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - lastTouchX;
                    const deltaY = touch.clientY - lastTouchY;
                    
                    // Rotate camera based on touch movement
                    camera.rotation.y -= deltaX * lookSensitivity;
                    camera.rotation.x -= deltaY * lookSensitivity * 0.5;
                    camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
                    
                    lastTouchX = touch.clientX;
                    lastTouchY = touch.clientY;
                }
            });
            
            // Look touch end
            rightTouchArea.addEventListener('touchend', (e) => {
                e.preventDefault();
                lookTouchActive = false;
            });
            
            // Prevent context menu on long press
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });
        }
        
        function updateJoystickPosition(touch) {
            const rect = document.getElementById('joystickBase').getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let deltaX = touch.clientX - centerX;
            let deltaY = touch.clientY - centerY;
            
            // Limit joystick to base circle
            const maxDistance = rect.width / 2;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            
            if (distance > maxDistance) {
                deltaX = (deltaX / distance) * maxDistance;
                deltaY = (deltaY / distance) * maxDistance;
            }
            
            joystickPosition.x = deltaX / maxDistance;
            joystickPosition.y = -deltaY / maxDistance; // Invert Y for intuitive control
            
            // Update joystick visual position
            document.getElementById('joystickHandle').style.transform = 
                `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
        }
        
        function setupButtonEvents() {
            // Shoot button
            document.getElementById('shootBtn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                shoot();
                vibrate(50); // Short vibration
            });
            
            // Reload button
            document.getElementById('reloadBtn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                reload();
                vibrate(30);
            });
            
            // Slow motion button
            document.getElementById('slowMotionBtn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                activateSlowMotion();
                vibrate(100);
            });
            
            // Start button
            document.getElementById('startButton').addEventListener('click', startGame);
            
            // Restart button
            document.getElementById('restartButton').addEventListener('click', restartGame);
        }
        
        function setupGyroscope() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ requires permission
                document.getElementById('startButton').addEventListener('click', async () => {
                    try {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission === 'granted') {
                            gyroEnabled = true;
                            initGyroscope();
                        }
                    } catch (error) {
                        console.log('Gyroscope permission denied');
                    }
                });
            } else {
                // Android and other browsers
                if ('DeviceOrientationEvent' in window) {
                    gyroEnabled = true;
                    initGyroscope();
                }
            }
        }
        
        function initGyroscope() {
            deviceOrientationControls = new THREE.DeviceOrientationControls(camera);
        }
        
        function setupAudio() {
            // Create audio context
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();
            
            // Resume audio context on user interaction
            document.addEventListener('touchstart', () => {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }, { once: true });
            
            // Generate sound effects (fallback if no internet)
            generateFallbackSounds();
        }
        
        function generateFallbackSounds() {
            // Simple beep for shoot sound
            const shootSound = document.getElementById('shootSound');
            if (!shootSound.src) {
                shootSound.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ';
            }
        }
        
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            gameActive = true;
            
            // Start game timer
            startGameTimer();
            
            // Play background music
            playBackgroundMusic();
            
            // Request fullscreen on mobile
            requestFullscreen();
            
            // Lock orientation if supported
            lockOrientation();
        }
        
       function requestFullscreen() {
    try {
        const elem = document.documentElement;
        if (elem.requestFullscreen && document.fullscreenEnabled) {
            elem.requestFullscreen().catch(err => {
                console.log('Fullscreen not available');
            });
        } else if (elem.webkitRequestFullscreen && document.webkitFullscreenEnabled) {
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen && document.msFullscreenEnabled) {
            elem.msRequestFullscreen();
        }
    } catch (err) {
        // Silently fail if fullscreen not allowed
        console.log('Fullscreen not available on this page');
    }
}
        function lockOrientation() {
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(err => {
                    console.log('Orientation lock not supported:', err);
                });
            }
        }
        
        function shoot() {
            if (!gameActive || ammo <= 0) return;
            
            ammo--;
            shotsFired++;
            updateHUD();
            
            // Play shoot sound
            playSound('shootSound');
            
            // Muzzle flash effect
            showMuzzleFlash();
            
            // Screen shake
            document.body.classList.add('screen-shake');
            setTimeout(() => {
                document.body.classList.remove('screen-shake');
            }, 200);
            
            // Raycast for hit detection
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            
            const intersects = raycaster.intersectObjects(bottles.filter(b => b.userData.active));
            
            if (intersects.length > 0) {
                const bottle = intersects[0].object.parent;
                destroyBottle(bottle);
                shotsHit++;
                
                // Combo system
                combo++;
                clearTimeout(comboTimeout);
                comboTimeout = setTimeout(() => {
                    combo = 0;
                    multiplier = 1;
                }, 3000); // 3 second combo window
                
                if (combo >= 3) {
                    multiplier = Math.min(multiplier + 0.5, 3);
                }
                
                // Add score
                score += Math.floor(100 * multiplier);
                
                // Show hit marker
                showHitMarker();
                
                // Play hit sound
                playSound('hitSound');
            }
            
            // Auto-reload if empty
            if (ammo === 0) {
                setTimeout(reload, 500);
            }
        }
        
        function destroyBottle(bottle) {
            if (!bottle.userData.active) return;
            
            bottle.userData.active = false;
            bottlesShot++;
            
            // Play breaking sounds
            playSound('bottleBreakSound');
            setTimeout(() => playSound('glassSound'), 100);
            
            // Create explosion particles
            createExplosion(bottle.position, bottle.userData.color);
            
            // Hide bottle
            bottle.visible = false;
            
            // Respawn bottle after delay
            setTimeout(() => {
                bottle.userData.active = true;
                bottle.visible = true;
                resetBottlePosition(bottle);
            }, 2000);
            
            // Update HUD
            updateHUD();
            
            // Chance to spawn power-up
            if (Math.random() < 0.2) {
                spawnPowerUp(bottle.position);
            }
        }
        
        function resetBottlePosition(bottle) {
            bottle.position.set(
                (Math.random() - 0.5) * 40,
                Math.random() * 10 + 5,
                -20 + Math.random() * 10
            );
            
            bottle.userData.velocity.set(
                (Math.random() - 0.5) * 0.5,
                Math.random() * 0.2,
                (Math.random() - 0.5) * 0.5
            );
        }
        
        function createExplosion(position, color) {
            const particleCount = 30;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const velocities = [];
            
            for (let i = 0; i < particleCount; i++) {
                positions[i * 3] = position.x;
                positions[i * 3 + 1] = position.y;
                positions[i * 3 + 2] = position.z;
                
                velocities.push(new THREE.Vector3(
                    (Math.random() - 0.5) * 0.5,
                    Math.random() * 0.5,
                    (Math.random() - 0.5) * 0.5
                ));
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const material = new THREE.PointsMaterial({
                size: 0.2,
                color: new THREE.Color(color),
                transparent: true,
                opacity: 1
            });
            
            const particles = new THREE.Points(geometry, material);
            particles.userData = { 
                velocities: velocities,
                life: 1.0,
                maxLife: 1.0 
            };
            
            scene.add(particles);
            particlesList.push(particles);
            
            // Play explosion sound
            playSound('explosionSound');
        }
        
        function spawnPowerUp(position) {
            // In a full implementation, this would spawn power-ups
            // For now, just recharge slow motion
            slowMotionCharge = Math.min(slowMotionCharge + 20, maxSlowMotion);
            updateHUD();
            
            // Show power-up indicator
            showPowerUpIndicator('Slow Motion +20%');
        }
        
        function reload() {
            if (ammo === maxAmmo || !gameActive) return;
            
            ammo = maxAmmo;
            updateHUD();
            
            playSound('reloadSound');
            vibrate(100);
        }
        
        function activateSlowMotion() {
            if (slowMotionCharge >= 30 && !slowMotionActive && gameActive) {
                slowMotionActive = true;
                slowMotionCharge -= 30;
                
                playSound('slowMotionSound');
                
                // Visual effect
                document.getElementById('slowMotionBtn').style.background = 
                    'linear-gradient(135deg, #ff6b6b 0%, #ff4757 100%)';
                
                setTimeout(() => {
                    slowMotionActive = false;
                    document.getElementById('slowMotionBtn').style.background = 
                        'linear-gradient(135deg, #3742fa 0%, #5352ed 100%)';
                }, slowMotionTime * 1000);
                
                updateHUD();
            }
        }
        
        function updateHUD() {
            // Score
            document.getElementById('score').textContent = score;
            
            // Ammo
            document.getElementById('ammoCount').textContent = ammo;
            document.getElementById('ammoFill').style.width = `${(ammo / maxAmmo) * 100}%`;
            
            // Slow motion
            document.getElementById('slowMotionFill').style.width = `${slowMotionCharge}%`;
            
            // Bottles shot (update if needed)
        }
        
        function showHitMarker() {
            const hitMarker = document.createElement('div');
            hitMarker.className = 'hit-marker';
            document.body.appendChild(hitMarker);
            
            setTimeout(() => {
                hitMarker.remove();
            }, 300);
        }
        
        function showMuzzleFlash() {
            // Simple muzzle flash effect
            const crosshair = document.getElementById('crosshair');
            crosshair.style.filter = 'brightness(3)';
            
            setTimeout(() => {
                crosshair.style.filter = 'brightness(1)';
            }, 50);
        }
        
        function showPowerUpIndicator(text) {
            const indicator = document.createElement('div');
            indicator.className = 'power-up-indicator';
            indicator.innerHTML = `
                <div class="power-up-icon">‚ö°</div>
                <div>${text}</div>
            `;
            
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.remove();
            }, 2000);
        }
        
        function showOrientationWarning() {
            // Optional: Show rotate device message
            console.log('Consider rotating to landscape for better experience');
        }
        
        function startGameTimer() {
            clearInterval(gameTimer);
            gameTimer = setInterval(() => {
                if (gameActive) {
                    gameTime--;
                    // FIXED: Added timeDisplay element update
                    document.getElementById('timeDisplay').textContent = gameTime;
                    
                    if (gameTime <= 0) {
                        endGame();
                    }
                    
                    // Recharge slow motion
                    if (!slowMotionActive) {
                        slowMotionCharge = Math.min(slowMotionCharge + 0.5, maxSlowMotion);
                        updateHUD();
                    }
                }
            }, 1000);
        }
        
        function endGame() {
            gameActive = false;
            clearInterval(gameTimer);
            
            // Calculate statistics
            const accuracy = shotsFired > 0 ? (shotsHit / shotsFired * 100).toFixed(1) : 0;
            
            // Update game over screen
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalBottles').textContent = bottlesShot;
            document.getElementById('finalAccuracy').textContent = accuracy + '%';
            document.getElementById('finalCombo').textContent = combo;
            document.getElementById('finalTime').textContent = gameTime + 's';
            
            // Show game over screen
            document.getElementById('gameOverScreen').style.display = 'flex';
        }
        
        function restartGame() {
            // Reset game state
            score = 0;
            bottlesShot = 0;
            ammo = maxAmmo;
            gameTime = 90;
            combo = 0;
            multiplier = 1;
            shotsFired = 0;
            shotsHit = 0;
            slowMotionCharge = maxSlowMotion;
            slowMotionActive = false;
            
            // Reset bottles
            bottles.forEach(bottle => {
                bottle.userData.active = true;
                bottle.visible = true;
                resetBottlePosition(bottle);
            });
            
            // Clear particles
            particlesList.forEach(particle => scene.remove(particle));
            particlesList = [];
            
            // Reset camera
            camera.position.set(0, 1.6, 0);
            camera.rotation.set(0, 0, 0);
            
            // Update HUD
            updateHUD();
            
            // Hide game over screen
            document.getElementById('gameOverScreen').style.display = 'none';
            
            // Start game
            gameActive = true;
            startGameTimer();
        }
        
        function playSound(soundId) {
            try {
                const sound = document.getElementById(soundId);
                sound.currentTime = 0;
                sound.play().catch(e => {
                    // Silent fail for autoplay restrictions
                });
            } catch (e) {
                // Fallback silent
            }
        }
        
        function playBackgroundMusic() {
            try {
                const music = document.getElementById('backgroundMusic');
                music.volume = 0.3;
                music.play().catch(e => {
                    // Music might not autoplay due to browser policies
                });
            } catch (e) {
                // Silent fail
            }
        }
        
        function vibrate(duration) {
            if (navigator.vibrate) {
                navigator.vibrate(duration);
            }
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function onOrientationChange() {
            // Handle orientation changes
            setTimeout(() => {
                onWindowResize();
            }, 100);
        }
        
        // Game loop
        function animate() {
            requestAnimationFrame(animate);
            
            const deltaTime = clock.getDelta();
            const timeScale = slowMotionActive ? 0.3 : 1;
            
            // Update camera with joystick input
            if (gameActive) {
                // Player movement
                const forward = new THREE.Vector3(0, 0, -1);
                const right = new THREE.Vector3(1, 0, 0);
                
                forward.applyEuler(camera.rotation);
                right.applyEuler(camera.rotation);
                
                forward.y = 0;
                right.y = 0;
                forward.normalize();
                right.normalize();
                
                // Apply joystick movement
                camera.position.add(forward.multiplyScalar(-joystickPosition.y * moveSpeed * deltaTime * timeScale));
                camera.position.add(right.multiplyScalar(joystickPosition.x * moveSpeed * deltaTime * timeScale));
                
                // Keep player within bounds
                camera.position.x = THREE.MathUtils.clamp(camera.position.x, -45, 45);
                camera.position.z = THREE.MathUtils.clamp(camera.position.z, -40, 40);
                
                // Update gyroscope controls if enabled
                if (gyroEnabled && deviceOrientationControls) {
                    deviceOrientationControls.update();
                }
                
                // Update bottles
                bottles.forEach(bottle => {
                    if (bottle.userData.active) {
                        // Apply physics
                        bottle.userData.velocity.y -= bottle.userData.gravity * deltaTime * timeScale;
                        bottle.position.add(bottle.userData.velocity.clone().multiplyScalar(deltaTime * timeScale));
                        
                        // Apply rotation
                        bottle.rotation.x += bottle.userData.angularVelocity.x * deltaTime * timeScale;
                        bottle.rotation.y += bottle.userData.angularVelocity.y * deltaTime * timeScale;
                        bottle.rotation.z += bottle.userData.angularVelocity.z * deltaTime * timeScale;
                        
                        // Bounce on ground
                        if (bottle.position.y < 0.5) {
                            bottle.position.y = 0.5;
                            bottle.userData.velocity.y *= -0.7;
                            
                            // Play grass sound on bounce
                            if (Math.random() < 0.3) {
                                playSound('glassSound');
                            }
                        }
                        
                        // Air resistance
                        bottle.userData.velocity.multiplyScalar(0.995);
                        bottle.userData.angularVelocity.multiplyScalar(0.99);
                    }
                });
                
                // Update particles - FIXED: particlesList is now defined
                particlesList.forEach((particle, index) => {
                    particle.userData.life -= deltaTime;
                    
                    if (particle.userData.life <= 0) {
                        scene.remove(particle);
                        particlesList.splice(index, 1);
                    } else {
                        const positions = particle.geometry.attributes.position.array;
                        const velocities = particle.userData.velocities;
                        
                        for (let i = 0; i < velocities.length; i++) {
                            positions[i * 3] += velocities[i].x * deltaTime;
                            positions[i * 3 + 1] += velocities[i].y * deltaTime;
                            positions[i * 3 + 2] += velocities[i].z * deltaTime;
                            
                            velocities[i].y -= 0.1 * deltaTime;
                        }
                        
                        particle.geometry.attributes.position.needsUpdate = true;
                        particle.material.opacity = particle.userData.life / particle.userData.maxLife;
                    }
                });
            }
            
            renderer.render(scene, camera);
        }
        
        // Initialize when page loads
        window.addEventListener('load', init);
        
        // Prevent pull-to-refresh
        document.addEventListener('touchmove', function(e) {
            if (gameActive) {
                e.preventDefault();
            }
        }, { passive: false });
        
    </script>
</body>
</html>
