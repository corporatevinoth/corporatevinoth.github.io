<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Third-Person Racing Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <style>
    html, body { margin:0; padding:0; height:100%; }
    body { background: linear-gradient(135deg,#b6f0ff 0%,#ffecd2 100%); overflow: hidden;}
    #score {
      position: absolute;
      top: 24px; left: 0; right: 0;
      color: #fff700;
      font-family: 'Arial Black', Arial, sans-serif;
      font-size: 2em;
      text-align: center;
      text-shadow: 2px 2px 8px #333;
      z-index: 10;
      letter-spacing: 2px;
      pointer-events: none;
    }
    .ctrl-btn {
      width: 18vw; max-width: 100px; min-width: 60px;
      aspect-ratio: 1/1;
      border-radius: 50%;
      background: #2C387E;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 18px #0006;
      font-size: 3em;
      color: #fff;
      border: 3px solid #fff;
      pointer-events: auto;
      touch-action: manipulation;
      user-select: none;
      transition: background 0.18s, color 0.18s;
      opacity: 0.96;
      position: fixed;
      bottom: 4vh; z-index: 100;
    }
    #leftBtn { left: 4vw; }
    #rightBtn { right: 4vw; }
    .ctrl-btn:active {
      background: #FFD600;
      color: #1a237e;
    }
    #threejs-canvas {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 1;
      display: block;
      touch-action: none;
    }
    @media (max-width: 600px) {
      #score { font-size: 1.25em;}
      .ctrl-btn { font-size: 2em; min-width: 50px;}
    }
  </style>
</head>
<body>
<div id="score">Lap: 1 / 3</div>
<div class="ctrl-btn" id="leftBtn">&#8592;</div>
<div class="ctrl-btn" id="rightBtn">&#8594;</div>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 500);
let renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.domElement.id = "threejs-canvas";
document.body.appendChild(renderer.domElement);

window.addEventListener('resize', ()=>{
  renderer.setSize(window.innerWidth,window.innerHeight);
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
});

// Lighting
let light = new THREE.DirectionalLight(0xffffff, 1.1);
light.position.set(0, 20, 15);
scene.add(light);
scene.add(new THREE.AmbientLight(0xf3e5ab, 0.7));

// Track
function createTrack() {
  let mat = new THREE.MeshPhongMaterial({color:0x444444});
  let geo = new THREE.BoxGeometry(16,0.6,300);
  let mesh = new THREE.Mesh(geo, mat);
  mesh.position.set(0,-0.6,150);
  scene.add(mesh);
  return mesh;
}
let track = createTrack();

// Lane markers
for(let i=0; i<30; i++) {
  let geo = new THREE.BoxGeometry(0.3,0.05,4);
  let mat = new THREE.MeshPhongMaterial({color:0xffffff});
  let mesh = new THREE.Mesh(geo, mat);
  mesh.position.set(0,0.1,i*10+5);
  scene.add(mesh);
}

// Simple car model
function createCar(color=0x1e88e5, y=0, isPlayer=true) {
  let group = new THREE.Group();
  let bodyMat = new THREE.MeshPhongMaterial({color});
  let body = new THREE.Mesh(new THREE.BoxGeometry(1.8,0.6,3.2), bodyMat);
  body.position.set(0, y+0.45, 0);
  group.add(body);
  let top = new THREE.Mesh(new THREE.BoxGeometry(1.22,0.55,1.5), new THREE.MeshPhongMaterial({color:0xcfd8dc}));
  top.position.set(0, y+0.92, 0.1);
  group.add(top);
  // Wheels
  for(let dx of [-0.75,0.75]) for(let dz of [-1.2,1.2]) {
    let wheel = new THREE.Mesh(new THREE.CylinderGeometry(0.29,0.29,0.22,16), new THREE.MeshPhongMaterial({color:0x111}));
    wheel.rotation.z = Math.PI/2;
    wheel.position.set(dx, y+0.18, dz);
    group.add(wheel);
  }
  group.position.set(0,0,4);
  return group;
}

// Player car
let player = createCar(0x1976d2, 0,true);
player.position.z = 6;
scene.add(player);

// AI cars
let aiCars = [];
for(let i=0;i<3;i++) {
  let car = createCar([0xd32f2f,0x388e3c,0xfbc02d][i],0,false);
  car.position.x = [-2.2,0,2.2][i];
  car.position.z = 2-i*3;
  scene.add(car);
  aiCars.push({obj:car, lane:i, speed:0.45+Math.random()*0.13});
}

// Speed boosts
let boosts = [];
function createBoost(x, z) {
  let geo = new THREE.TorusGeometry(0.6, 0.18, 16, 32);
  let mat = new THREE.MeshPhongMaterial({color:0x00e676, emissive:0x5cffd5, emissiveIntensity:0.7});
  let mesh = new THREE.Mesh(geo, mat);
  mesh.position.set(x,0.5,z);
  mesh.rotation.x = Math.PI/2;
  scene.add(mesh);
  boosts.push(mesh);
}
function spawnBoosts() {
  boosts.forEach(b=>scene.remove(b));
  boosts = [];
  for(let i=0;i<8;i++) {
    let lane = [-4, 0, 4][Math.floor(Math.random()*3)];
    createBoost(lane, 24+Math.random()*250);
  }
}
spawnBoosts();

// Decorations: trees
let decorations = [];
function createTree(x, z) {
  let group = new THREE.Group();
  let trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.17,0.21,1.2,8), new THREE.MeshPhongMaterial({color:0x8d5524}));
  trunk.position.y = 0.6;
  let leaves = new THREE.Mesh(new THREE.SphereGeometry(0.66,12,10), new THREE.MeshPhongMaterial({color:0x388e3c}));
  leaves.position.y = 1.3;
  group.add(trunk); group.add(leaves);
  group.position.set(x,0,z);
  scene.add(group);
  decorations.push(group);
}
for(let i=0;i<44;i++) {
  createTree(-9.5-Math.random()*2, 7+i*7+Math.random()*5);
  createTree(9.5+Math.random()*2, 7+i*7+Math.random()*5);
}

// Controls
let lanes = [-4, 0, 4], targetLane=1;
function moveLeft() { targetLane=Math.max(0,targetLane-1);}
function moveRight(){ targetLane=Math.min(2,targetLane+1);}

document.getElementById('leftBtn').addEventListener('touchstart', moveLeft);
document.getElementById('leftBtn').addEventListener('mousedown', moveLeft);
document.getElementById('rightBtn').addEventListener('touchstart', moveRight);
document.getElementById('rightBtn').addEventListener('mousedown', moveRight);
window.addEventListener('keydown', function(e){
  if(e.key==='ArrowLeft'||e.key==='a') moveLeft();
  if(e.key==='ArrowRight'||e.key==='d') moveRight();
});

// Game state
let speed = 0.62, maxLap=3, lap=1, finishLine=295;
let scoreDiv = document.getElementById("score");
let boosting = false, boostTime=0, boostDuration=60;

// Camera follows behind car
function updateCamera() {
  let carPos = player.position;
  camera.position.lerp(
    new THREE.Vector3(carPos.x, carPos.y+4.8, carPos.z-8.5),
    0.16
  );
  camera.lookAt(new THREE.Vector3(carPos.x,carPos.y+1,carPos.z+12));
}

// Main loop
function animate() {
  // Player movement
  let tx = lanes[targetLane];
  player.position.x += (tx-player.position.x)*0.18;
  if(boosting) speed=1.07; else speed=0.62;
  player.position.z += speed;

  // AI logic
  aiCars.forEach((a,i)=>{
    a.obj.position.z += a.speed + Math.sin(Date.now()/1200+i)*0.05;
    // Change lane randomly
    if(Math.random()<0.012){
      let newLane = Math.floor(Math.random()*3);
      a.lane = newLane;
    }
    let tx = lanes[a.lane];
    a.obj.position.x += (tx-a.obj.position.x)*0.13;
    // Loop AI cars
    if(a.obj.position.z>finishLine+3) a.obj.position.z -= finishLine-12;
  });

  // Boosts
  for(let i=boosts.length-1;i>=0;i--) {
    let b = boosts[i];
    b.rotation.z += 0.09;
    if(
      Math.abs(player.position.z-b.position.z)<2.2 &&
      Math.abs(player.position.x-b.position.x)<2.1
    ) {
      scene.remove(b);
      boosts.splice(i,1);
      boosting = true; boostTime=boostDuration;
    }
  }
  if(boosting) {
    boostTime--;
    if(boostTime<=0) boosting=false;
  }
  if(boosts.length<3) spawnBoosts();

  // Finish line & Lap logic
  if(player.position.z>finishLine) {
    lap++;
    if(lap>maxLap) {
      scoreDiv.innerText = "🏁 Finished! Reload to play again.";
      return;
    }
    player.position.z = 6;
    aiCars.forEach(a=>a.obj.position.z=2-Math.random()*8);
    spawnBoosts();
    scoreDiv.innerText = "Lap: "+lap+" / "+maxLap;
  } else {
    scoreDiv.innerText = "Lap: "+lap+" / "+maxLap;
  }

  // Loop decorations
  decorations.forEach(obj=>{
    if(obj.position.z<player.position.z-8) obj.position.z+=finishLine-12;
  });

  updateCamera();
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}
animate();

</script>
</body>
</html>
